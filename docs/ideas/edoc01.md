# 系统总结以及重新搭建的思考

> 随着各种升级的新需求，以前那套拿来发家的系统架构已经不太适合在这个各种容器、虚拟化的程序世界里排的上号了，虽然各种维护还能让他艰难的运行起来，但是让他运行起来的这个过程就像是在煎中药。
所以打算重新思考下整体架构和优化以前的流程。

---

## 业务架构

按照以往在上汽通用接触过的Archi架构，也可以理解为华为的4A架构，分为应用架构，业务架构，技术架构，数据架构。这次只进行业务架构的梳理，看下能否打到Level3层级。

![业务架构](https://s2.loli.net/2024/05/29/EvB17V4i5RNds2t.png)

---

## 技术路线

按照之前的设计方案，在2021年尝试搭建企业级管理系统后端，计划是用OAuth2做鉴权，结果这个真的是太重量级了，而当时研究Shrio和JWT没有研究透，所以一直搁置。
前面的记录已经实现了JWT和Shiro，技术路线是Dubbo+SpringBoot+SpringDataJPA，前端使用VUE。

![上传影像流程](https://s2.loli.net/2024/05/29/tER5CVexbylYHqf.png)

现在纠结的点在于是否需要先落地影像，如果落地的话，还需要建立一张临时的表或者说存MongoDB，上传完成后进行数据的删除。
如果不存MongoDB，直接拿bytes文件进行返回，这样的话在JVM内存中就会占用比较多的资源，虽然以前的发家的项目就是这样做的。

另外还有一个痛苦的点，在于识别信息封装返回这里：
```json
{
  "bytes": "bytes",
  "resultData": [
    {
      "index": 1,
      "type": "invoice_vat",
      "sliceRect": {
        "x1": 0,
        "x2": 0,
        "x3": 0,
        "x4": 0,
        "y1": 0,
        "y2": 0,
        "y3": 0,
        "y4": 0
      },
      "data": {
        "invNo": "",
        "invNumber": "",
        "invCode": ""
      }
    }
  ]
}
```

如果按照这种结构进行返回，既每个bytes都是同一张影像信息，就需要保存多张同一影像，然后在预览时通过Group By的操作进行分组，这种较耗性能；

写到这里，突然觉得还是先保存影像，拿到ID信息进行返回会比较合适：
```json
{
  "imgId": 1,
  "resultData": [
    {
      "index": 1,
      "type": "invoice_vat",
      "sliceRect": {
        "x1": 0,
        "x2": 0,
        "x3": 0,
        "x4": 0,
        "y1": 0,
        "y2": 0,
        "y3": 0,
        "y4": 0
      },
      "data": {
        "invNo": "",
        "invNumber": "",
        "invCode": ""
      }
    }
  ]
}
```

影像有且仅有保存一次，然后通过保存发票信息时，将imgId和Invoice进行关联设置，将后续JSON中的SliceRect进行单独保存，建立关联关系，实现区域的划分以及水印；


